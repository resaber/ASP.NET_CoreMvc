 @model IEnumerable<prjCatCoffe.Models.Member>

@{
    ViewData["Title"] = "List";
}

<h1>會員資料一覽表</h1>


<div class="bar d-flex align-items-center gap-2">
    @using (Html.BeginForm())
    {
        <div class="d-flex align-items-center gap-2">
            <label for="txtKeyword">關鍵字</label>
            @Html.TextBox("txtKeyword", null, new { @class = "form-control", @style = "width: 150px;" })
            <input type="submit" value="查詢" class="btn btn-primary" />
        </div>
    }

    <select id="selectPerson" class="form-control" style="width: 150px;">
        <option selected disabled>請選擇身分</option>
    </select>
</div>

<p>
    <a asp-action="Create">新增會員</a>
</p>

@section Styles{
    <style>
        table th, table td {
            text-align: center; /* 水平置中 */
            vertical-align: middle; /* 垂直置中 */
        }

        th {
            white-space: nowrap;
        }
    </style>
  
  }
         

<table class="table table-hover">
    <thead>
        <tr>
            <th>
                序號
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.ImageUrl)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Account)
            </th>

            <th>
                @Html.DisplayNameFor(model => model.Phone)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Gender)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Email)
            </th>
           
            <th>
                @Html.DisplayNameFor(model => model.IsCaterer)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.CreatedAt)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.UpdatedAt)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Status)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @{
            int count = 0;
            foreach (var item in Model)
            {
                count++;
                <tr>                  
                    <td>
                        @count
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Name)
                    </td>
                    <td>
                        @* 有圖片給設定的圖片沒有的話給預設值 *@
                        <img src="~/images/member_photos//@(string.IsNullOrEmpty(item.ImageUrl) ? "default-user.jpg" : item.ImageUrl)" width="80" height="50" />
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Account)
                    </td>

                    <td>
                        @Html.DisplayFor(modelItem => item.Phone)
                    </td>
                    <td>
                        @item.GenderDisplay
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Email)
                    </td>
                    
                    <td>
                        @Html.DisplayFor(modelItem => @item.IsCatererDisplay)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.CreatedAt)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.UpdatedAt)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => @item.StatusDisplay)
                    </td>
                    <td>
                        @Html.ActionLink("編輯", "Edit", "Member", new { id = item.MemberId },null)
                        @Html.ActionLink("刪除", "Delete", "Member", new { id = item.MemberId }, 
                             new { onclick = "return confirm('要刪除這筆會員資料嗎?')" })

                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@section Scripts{
    <script>
        const selPerson = document.querySelector("#selectPerson");
        //套用IFFE
        //讀出資料把使用者身分顯示 例如這裡只有會員或是業者 依照Member資料表 is_caterer是 0 會員 或是 1業者顯示在select option//串接資料庫資料表 要想一下怎麼做
        (async () => {
          try {
            //api路徑
            const response = await fetch("/api/MemberApi/GetRoles");
            const datas = await response.json(); //解析拿到JSON

            const roleOptionsHtml = datas.map(role => {
              return `<option value="${role}">${role}</option>`;
            });
            //把每個元素拆開
            selPerson.innerHTML += roleOptionsHtml.join('');
          } catch (err) {
            console.error("發生錯誤：", err);
            selPerson.innerHTML = `<option disabled>資料載入失敗</option>`;
          }
        })(); // ✅ 呼叫 IIFE，這是你漏掉的關鍵


        //顯示下方table更新資料
        selPerson.addEventListener("change", async () => {
          //去拿option 裡面的Value屬性的值
          const selectedRole = selPerson.value;

          try {
              
            const response = await fetch(`/api/MemberApi/GetMembersByRole?role=${selectedRole}`);
            const members = await response.json();

            const tbody = document.querySelector("tbody");
            let count = 1;

            const rowsHtml = members.map(m => {
              return `
                <tr>
                  <td>${count++}</td>
                  <td>${m.name}</td>
                  <td><img src="/images/member_photos/${m.imageUrl || 'default-user.jpg'}" width="80" height="50"/></td>
                  <td>${m.account}</td>
                  <td>${m.phone}</td>
                  <td>${m.gender === 1 ? '女' : '男'}</td>
                  <td>${m.email}</td>
                  <td>${m.isCaterer ? '業者' : '會員'}</td>
                  <td>${m.createdAt}</td>
                  <td>${m.updatedAt}</td>
                  <td>${m.status ? '啟用' : '停用'}</td>
                  <td>
                    <a href="/Member/Edit/${m.memberId}">編輯</a>
                    <a href="/Member/Delete/${m.memberId}" onclick="return confirm('要刪除這筆會員資料嗎?')">刪除</a>
                  </td>
                </tr>
              `;
            });

            tbody.innerHTML = rowsHtml.join('');
          } catch (err) {
            console.error("讀取會員清單失敗", err);
          }
        });
    </script>
}